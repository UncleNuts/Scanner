<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Event Scanner</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
      background: #121212;
      color: white;
      text-align: center;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    #header {
      padding: 20px;
      background: #1a1a1a;
    }
    #scanner-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    #qr-reader {
      width: 90%;
      max-width: 400px;
      margin: 0 auto;
      display: none;
    }
    #result-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 100;
      font-size: 24px;
    }
    .status-icon {
      font-size: 80px;
      margin-bottom: 20px;
    }
    .approved { color: #4CAF50; }
    .declined { color: #F44336; }
    .not-found { color: #FF9800; }
    #loading { margin: 20px; }
    #error-message { 
      color: #F44336; 
      margin: 20px; 
      display: none;
      padding: 0 20px;
    }
    #retry-button {
      background: #6200EE;
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 18px;
      border-radius: 50px;
      margin: 20px;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    #camera-feed {
      width: 100%;
      max-width: 400px;
      background: black;
      display: none;
    }
  </style>
</head>
<body>
  <div id="header">
    <h1>Event Scanner</h1>
  </div>
  <div id="scanner-container">
    <video id="camera-feed" playsinline></video>
    <div id="qr-reader"></div>
    <div id="loading">Initializing camera...</div>
    <div id="error-message"></div>
    <button id="retry-button">Retry Camera</button>
  </div>
  <div id="result-overlay">
    <div id="status-icon" class="status-icon"></div>
    <div id="status-message"></div>
  </div>

  <script>
    // ===== SCANNER CONFIGURATION =====
    const config = {
      scannerCDN: "https://unpkg.com/html5-qrcode@2.3.8/dist/html5-qrcode.min.js",
      apiEndpoint: "https://script.google.com/macros/s/AKfycbxr6HzIO5guIs0L28OH4dt6a8c04cQ5EI7S9YYdtDdcEJigc5Ep4TlXJ1d-eFoROeiT/exec",
      cameraFacingMode: "environment" // "user" for front camera
    };

    // ===== SCANNER STATE =====
    let scanner = {
      html5QrCode: null,
      isScanning: false,
      currentCamera: null
    };

    // ===== DOM ELEMENTS =====
    const elements = {
      qrReader: document.getElementById('qr-reader'),
      loading: document.getElementById('loading'),
      errorMsg: document.getElementById('error-message'),
      retryBtn: document.getElementById('retry-button'),
      resultOverlay: document.getElementById('result-overlay'),
      statusIcon: document.getElementById('status-icon'),
      statusMsg: document.getElementById('status-message'),
      cameraFeed: document.getElementById('camera-feed')
    };

    // ===== MAIN FUNCTIONS =====
    async function initScanner() {
      // Reset UI
      elements.loading.style.display = 'block';
      elements.errorMsg.style.display = 'none';
      elements.retryBtn.style.display = 'none';
      elements.qrReader.style.display = 'none';
      elements.cameraFeed.style.display = 'none';
      
      try {
        // 1. Load scanner library if needed
        if (!window.Html5Qrcode) {
          await loadScript(config.scannerCDN);
        }

        // 2. Initialize scanner
        scanner.html5QrCode = new Html5Qrcode("qr-reader");
        
        // 3. Get camera list
        const cameras = await scanner.html5QrCode.getCameras();
        if (cameras.length === 0) {
          throw new Error("No cameras found. Please check permissions.");
        }

        // 4. Find preferred camera (back camera)
        const preferredCamera = cameras.find(cam => 
          cam.label.toLowerCase().includes("back") || 
          cam.label.toLowerCase().includes("rear")
        ) || cameras[0];

        // 5. Start camera preview
        elements.cameraFeed.style.display = 'block';
        await scanner.html5QrCode.start(
          preferredCamera.id,
          {
            fps: 10,
            qrbox: 250,
            videoConstraints: {
              facingMode: config.cameraFacingMode
            }
          },
          onScanSuccess,
          onScanError
        );
        
        // 6. Update UI
        elements.loading.style.display = 'none';
        scanner.isScanning = true;
        
      } catch (error) {
        handleError(error);
      }
    }

    async function onScanSuccess(ticketId) {
      scanner.isScanning = false;
      await scanner.html5QrCode.stop();
      elements.qrReader.style.display = 'none';
      elements.cameraFeed.style.display = 'none';
      
      showResult("⌛", "Processing...", "white");
      
      try {
        // Verify ticket
        const response = await fetch(config.apiEndpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ticketId })
        });
        const result = await response.json();

        if (result.success) {
          showResult("✅", `Approved: ${ticketId}`, "approved");
        } else {
          showResult("❌", result.message || "Ticket invalid", "declined");
        }
      } catch (error) {
        showResult("⚠️", "Verification failed", "declined");
      }
      
      // Restart scanner after delay
      setTimeout(initScanner, 2000);
    }

    function onScanError(error) {
      console.debug("Scan error:", error);
    }

    function handleError(error) {
      console.error("Scanner error:", error);
      elements.loading.style.display = 'none';
      elements.errorMsg.style.display = 'block';
      elements.errorMsg.textContent = error.message;
      elements.retryBtn.style.display = 'block';
      elements.cameraFeed.style.display = 'none';
    }

    function showResult(icon, message, className) {
      elements.statusIcon.textContent = icon;
      elements.statusMsg.textContent = message;
      elements.statusIcon.className = `status-icon ${className}`;
      elements.resultOverlay.style.display = 'flex';
    }

    async function loadScript(src) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = () => reject(new Error(`Failed to load script: ${src}`));
        document.head.appendChild(script);
      });
    }

    // ===== INITIALIZATION =====
    document.addEventListener('DOMContentLoaded', () => {
      elements.retryBtn.addEventListener('click', () => {
        if (scanner.html5QrCode && scanner.isScanning) {
          scanner.html5QrCode.stop();
        }
        initScanner();
      });
      
      initScanner();
    });
  </script>
</body>
</html>
